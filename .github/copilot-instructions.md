# Oregon Invasive Species Hotline – AI Guide

- **Purpose**: Django 5.2 + PostGIS app for crowdsourced invasive species reports; experts triage, comment, and finalize determinations. Celery handles email and maintenance tasks. Frontend uses server-rendered Bootstrap 5 templates via jsDelivr CDN.
- **Run (dev)**: `docker compose up` after creating secrets in `docker/secrets/{db_password.txt,google_api_key.txt,secret_key.txt}`. Site on 8000; Mailpit on 8025. PgAdmin optional via `docker-compose --profile dev-tools up pgadmin` (5050).
- **Tests**: In containers `make test_container` (keeps DB, failfast). Locally with Pipenv: `pipenv shell && make test`. Static analysis (WSL on Windows): `pipenv shell && ruff check .` and `pyright`.
- **Apps**: Core modules under `oregoninvasiveshotline/` — `reports`, `species`, `comments`, `images`, `notifications`, `permissions`, `users`, `pages`, `counties`. URLs live in [oregoninvasiveshotline/urls.py](oregoninvasiveshotline/urls.py) (regex-style paths kept for backwards compatibility).
- **Auth model**: Custom `users.User` (email is username) with nonstandard semantics: `is_active` means “manager can log in/manage reports”; `is_staff` means full admin. Authentication backend is `AllowAllUsersModelBackend`, so inactive users still authenticate for token links. `User.get_authentication_url()` issues signed, 24h login links (TimestampSigner) for email flows.
- **Permissions helper**: View guards wrap class-based views via `permissions.is_staff` / `permissions.is_active` decorators instead of DRF permissions. Avoid bypassing these helpers when adding views.
- **Reports domain**: `Report` stores GIS `PointField`, category/species (reported vs actual), EDRR status, ownership (`claimed_by`), and visibility flags. Icons auto-generate on save ([reports/models.py](oregoninvasiveshotline/reports/models.py)); `image_url` picks the newest public image or comment image and lazily creates thumbnails.
- **Async/Celery**: Celery app in [oregoninvasiveshotline/celery.py](oregoninvasiveshotline/celery.py) with broker from `CELERY_BROKER_URL`. Beat schedules nightly tasks in [settings.py](oregoninvasiveshotline/settings.py): `clear_expired_sessions` and `generate_icons`. Email notifications run out-of-band: submission ack, subscriber alerts, invite reviewers, subscription owner changes (see `reports/tasks.py`, `notifications/tasks.py`). When creating new emails, prefer Celery tasks and reuse `build_absolute_url` for deep links.
- **Subscriptions**: Saved report searches (`UserNotificationQuery.query`) store raw GET strings; rehydrated into `ReportSearchForm` inside `notify_report_subscribers`. Preserve this contract when changing search params or form field names.
- **Context + CSP**: Global template context injects env/version/Sentry trace IDs via [context_processors.py](oregoninvasiveshotline/context_processors.py). Strict CSP set in `CONTENT_SECURITY_POLICY` (jsDelivr + Google Maps + fonts); keep new assets within allowed sources.
- **Media/static**: `MEDIA_ROOT`/`MEDIA_URL` drive uploaded images, generated icons (`generated_icons`), and thumbnails (`generated_thumbnails`). Static files served via Django; storage backend configurable via `STATICFILES_STORAGE` env.
- **Settings/env**: Config pulled from `.env` and Docker secrets via `read_secret` (e.g., DB, Google keys, Sentry). `DJANGO_ENV` toggles prod hardening (SSL redirect, HSTS) and adds legacy `RubyPasswordHasher` in prod.
- **Front-end templates**: Located in `templates/` and app subfolders; Bootstrap components customized there. Base template adds CDN assets and Google Maps key.
- **Testing utilities**: `oregoninvasiveshotline/utils/test` holds helpers used by tests (no tests live there).
- **Gotchas**: Keep `Report` icon generation signal intact; image/icon paths assume POSIX separators via `posixpath`. Public/private image handling relies on `Visibility` enum in `visibility.py`. Do not repurpose `is_active` for soft-delete.

Ask if any workflows or conventions are still unclear.